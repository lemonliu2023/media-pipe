(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{5217:(e,t,n)=>{Promise.resolve().then(n.bind(n,5719))},5719:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>o});var r=n(5881),i=n(6797),a=n(8915);let s=function(e){let{width:t,height:n,poseLandmarkerRef:s}=e,[o,c]=(0,i.useState)(!1),d=(0,i.useRef)(null),l=(0,i.useRef)(null),u=(0,i.useRef)(null),[h,f]=(0,i.useState)(0),g=(0,i.useRef)("standing"),v=(0,i.useRef)("undefined"!=typeof Audio?new Audio("".concat(location.href,"/silent_1s.mp3")):void 0);async function y(){async function e(){if(d.current){if(d.current.readyState>=2){var t;!function(e){let t=u.current,n=d.current,r=l.current;t&&n&&r&&(t.save(),t.clearRect(0,0,r.width,r.height),t.translate(r.width,0),t.scale(-1,1),t.drawImage(n,0,0,r.width,r.height),t.restore(),e.landmarks&&e.landmarks.length>0&&(function(e){let t=u.current,n=l.current;if(t&&n){for(let r of(t.fillStyle="red",t.strokeStyle="green",t.lineWidth=2,a.Pi.POSE_CONNECTIONS)){let i=e[r.start],a=e[r.end];w(i)&&w(a)&&(t.beginPath(),t.moveTo((1-i.x)*n.width,i.y*n.height),t.lineTo((1-a.x)*n.width,a.y*n.height),t.stroke())}for(let r of e)w(r)&&(t.beginPath(),t.arc((1-r.x)*n.width,r.y*n.height,5,0,2*Math.PI),t.fill())}}(e.landmarks[0]),function(e){let t=e[23],n=e[25],r=e[27],i=e[24],a=e[26],s=e[28];if(!w(t)||!w(n)||!w(r)||!w(i)||!w(a)||!w(s))return;function o(e,t,n){let r={x:e.x-t.x,y:e.y-t.y},i={x:n.x-t.x,y:n.y-t.y},a=r.x*i.x+r.y*i.y,s=Math.sqrt(r.x**2+r.y**2);return 180/Math.PI*Math.acos(Math.min(Math.max(a/(s*Math.sqrt(i.x**2+i.y**2)),-1),1))}let c=o(t,n,r),d=o(i,a,s),l=(t.y+i.y)/2,u=(n.y+a.y)/2,h=(c+d)/2<100&&l>.9*u,y=g.current,x=v.current;"standing"===y&&h?g.current="squatting":"squatting"!==y||h||(g.current="standing",f(e=>e+1),null==x||x.play().catch(e=>console.error("音效播放失败:",e)))}(e.landmarks[0])))}(await (null==(t=s.current)?void 0:t.detectForVideo(d.current,performance.now())))}requestAnimationFrame(e)}}e()}function w(e){return!(e.visibility<.5)&&e.x>=0&&e.x<=1&&e.y>=0&&e.y<=1}return(0,i.useEffect)(()=>{l.current&&(u.current=l.current.getContext("2d"),u.current||console.error("Failed to get canvas context"))},[]),(0,i.useEffect)(()=>{let e,r;if(!d.current||!l.current)return;let i=d.current.videoWidth/d.current.videoHeight;i>t/n?(e=t,r=t/i):(r=n,e=n*i),l.current.style.width="".concat(e,"px"),l.current.style.height="".concat(r,"px")},[t,n]),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"relative bg-[#000]",style:{width:t,height:n,display:o?"block":"none"},children:[(0,r.jsxs)("div",{id:"render-wrapper",className:"flex justify-center items-center",children:[(0,r.jsx)("video",{ref:d,autoPlay:!0,playsInline:!0,style:{display:"none"}}),(0,r.jsx)("canvas",{ref:l,width:t,height:n})]}),(0,r.jsxs)("div",{id:"counter",style:{backgroundColor:"rgba(0, 0, 0, 0.5)"},className:"fixed top-[20px] left-[20px] text-[#fff] text-2xl p-[10px] rounded-[10px]",onClick:()=>{var e;null==(e=v.current)||e.play().catch(e=>console.error("音效播放失败:",e))},children:["深蹲次数: ",h]})]}),(0,r.jsx)("div",{style:{display:o?"none":"block"},children:(0,r.jsx)("button",{onClick:()=>void new Promise((e,t)=>{navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia({video:{facingMode:"user",width:{ideal:1280},height:{ideal:720}},audio:!1}).then(t=>e(t)):navigator.getUserMedia?navigator.getUserMedia({video:!0,audio:!1},t=>e(t),e=>t(e.message)):t("Your browser does not support getUserMedia API")}).then(e=>{d.current&&(d.current.srcObject=e,d.current.addEventListener("loadedmetadata",function(){if(l.current){var e,t;l.current.width=(null==(e=d.current)?void 0:e.videoWidth)||0,l.current.height=(null==(t=d.current)?void 0:t.videoHeight)||0}})),c(!0),y();let t=v.current;null==t||t.play().then(()=>{t.pause(),t.currentTime=0,v.current=new Audio("".concat(location.href,"/mario-coin.wav"))})}).catch(e=>{console.error(e)}),children:"打开摄像头"})})]})};function o(){let[e,t]=(0,i.useState)(!1),n=(0,i.useRef)(null),[o,c]=(0,i.useState)({width:0,height:0});return(0,i.useEffect)(()=>{let e=()=>{c({width:window.innerWidth,height:window.innerHeight})};return e(),window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}},[]),(0,i.useEffect)(()=>{t(!0),(async()=>{let e=await a.Ps.forVisionTasks("".concat(window.location.href,"/wasm"));n.current=await a.Pi.createFromOptions(e,{baseOptions:{modelAssetPath:"".concat(window.location.href,"/pose_landmarker_lite.task"),delegate:"GPU"},runningMode:"VIDEO",numPoses:1,minPoseDetectionConfidence:.5,minTrackingConfidence:.5})})().then(()=>{t(!1)})},[]),(0,r.jsx)("div",{className:"flex justify-center items-center h-screen overflow-hidden",children:e?(0,r.jsx)("div",{children:"模型加载中..."}):(0,r.jsx)(s,{width:o.width,height:o.height,poseLandmarkerRef:n})})}}},e=>{var t=t=>e(e.s=t);e.O(0,[915,364,770,358],()=>t(5217)),_N_E=e.O()}]);